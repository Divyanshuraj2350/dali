import spotipy
from spotipy.oauth2 import SpotifyOAuth
import time
import os
from gtts import gTTS
import subprocess 
import speech_recognition as sr

r = sr.Recognizer()

# Spotify credentials (optional - only needed if you use music features)
client_id = 'your-client-id'
client_secret = 'your-client-secret'
redirect_uri = 'http://127.0.0.1:8888/callback'

# Global variables - will be initialized only when needed
sp_oauth = None
sp = None

def initialize_spotify():
    """Initialize Spotify only when needed"""
    global sp_oauth, sp
    
    if sp is not None:
        return sp  # Already initialized
    
    try:
        sp_oauth = SpotifyOAuth(
            client_id=client_id,
            client_secret=client_secret,
            redirect_uri=redirect_uri,
            scope=['user-read-playback-state', 'user-modify-playback-state', 'streaming', 'user-library-read']
        )
        sp = spotipy.Spotify(auth_manager=sp_oauth)
        print("Spotify initialized successfully")
        return sp
    except Exception as e:
        print(f"Spotify initialization error: {e}")
        return None

def read_aloud(input_text):
    """Convert text to speech using gTTS and play it"""
    try:
        tts = gTTS(text=input_text, lang='en', slow=False)
        tts.save('output_music.mp3')
        subprocess.run(['afplay', 'output_music.mp3'])
    except Exception as e:
        print(f"TTS Error in music.py: {e}")

def search_play():
    """Search and play a song on Spotify"""
    # Initialize Spotify only when this function is called
    spotify = initialize_spotify()
    
    if spotify is None:
        error = "Spotify is not configured. Please add your Spotify credentials."
        print("Dali:", error)
        read_aloud(error)
        return
    
    try:
        search = "Tell me the name of the song you want to search for"
        print("Dali:", search)
        read_aloud(search)
        
        with sr.Microphone() as source:
            audio = r.listen(source, timeout=10)
            song = r.recognize_google(audio)
            print(f"You said: {song}")
            
            results = spotify.search(q=song, limit=1, type='track')
            
            if not results['tracks']['items']:
                error = "Sorry, I couldn't find that song"
                print("Dali:", error)
                read_aloud(error)
                return
            
            for i, t in enumerate(results['tracks']['items']):
                print(f"{i+1}. {t['name']} - {t['artists'][0]['name']}")
            
            ask = "Are you sure you want to play this?"
            print("Dali:", ask)
            read_aloud(ask)
            
            audio = r.listen(source, timeout=5)
            choice = r.recognize_google(audio)
            
            if any(word in choice.lower() for word in ["yes", "definitely", "yeah", "sure"]):
                track_id = results['tracks']['items'][0]['id']
                
                # Start playback
                spotify.start_playback(uris=[f'spotify:track:{track_id}'])
                
                track = spotify.track(track_id)
                name = track['name']
                artist = track['artists'][0]['name']
                
                play = f"Playing {name} by {artist}"
                print("Dali:", play)
                read_aloud(play)
            else:
                text = "Okay, maybe next time"
                print("Dali:", text)
                read_aloud(text)
    
    except sr.UnknownValueError:
        error = "I couldn't understand what you said"
        print("Dali:", error)
        read_aloud(error)
    except Exception as e:
        error = f"Error playing music: {e}"
        print("Dali:", error)
        read_aloud("Sorry, I couldn't play the music")

def pause():
    """Pause currently playing track"""
    spotify = initialize_spotify()
    
    if spotify is None:
        return
    
    try:
        spotify.pause_playback()
        pause_msg = "Song paused"
        print("Dali:", pause_msg)
        read_aloud(pause_msg)
    except Exception as e:
        print(f"Pause error: {e}")
        read_aloud("Could not pause the song")

def resume():
    """Resume currently playing track"""
    spotify = initialize_spotify()
    
    if spotify is None:
        return
    
    try:
        spotify.start_playback()
        play_msg = "Song resumed"
        print("Dali:", play_msg)
        read_aloud(play_msg)
    except Exception as e:
        print(f"Resume error: {e}")
        read_aloud("Could not resume the song")

